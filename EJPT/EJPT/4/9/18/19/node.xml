<?xml version="1.0" encoding="UTF-8"?>
<cherrytree>
  <node name="Access Token Impersonation" unique_id="19" prog_lang="custom-colors" tags="" readonly="0" nosearch_me="0" nosearch_ch="0" custom_icon_id="0" is_bold="0" foreground="" ts_creation="1704144396" ts_lastsave="1704144543">
    <rich_text>Access Tokens are a core component of the authentication process on Windows and are created and managed by lsass.exe

Generated by winlogon.exe everytime the user auths and include the identity and privs of the user account associated with the thread or process. This token is attached to the unerinit.exe process. Then all child processes will inherit the processes started by the user and will run under the privs of the same access token.

Access tokens are categorized based on the security level assigned to them.

Impersonate level tokens are a resolve of a non-interactive login on windows normally from a service or domain logon. Impersonate level tokens are used to impersonate a token on the local system.

Delegate level tokens are typically created through an interactive login ( incl RDP ). These pose the biggest threat as they can be used to impersonate tokens on any system.

**Tools**

We will be using a meterpreter session, and the incognito module. Can also use a "potato attack".

NOTE: Once you start your meterpreter session. Run getprivs and look for </rich_text>
    <rich_text weight="heavy">SeImpersonatePrivilege</rich_text>
    <rich_text>. This is the priv you need for token impersonation.

</rich_text>
    <codebox char_offset="1150" justification="left" frame_width="500" frame_height="55" width_in_pixels="1" syntax_highlighting="sh" highlight_brackets="1" show_line_numbers="0">load incognito
list_tokens -u
impersonate_token "nameof\token"</codebox>
  </node>
</cherrytree>
